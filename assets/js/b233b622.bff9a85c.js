"use strict";(self.webpackChunkplatformatic_oss_website=self.webpackChunkplatformatic_oss_website||[]).push([[23882],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>c});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=p(n),c=o,g=m["".concat(s,".").concat(c)]||m[c]||d[c]||r;return n?a.createElement(g,i(i({ref:t},u),{},{components:n})):a.createElement(g,i({ref:t},u))}));function c(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},77228:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(87462),o=(n(67294),n(3905));const r={},i="Movie Quotes App Tutorial",l={unversionedId:"getting-started/movie-quotes-app-tutorial",id:"version-0.0.22/getting-started/movie-quotes-app-tutorial",title:"Movie Quotes App Tutorial",description:"This tutorial will help you learn how to build a full stack application on top",source:"@site/versioned_docs/version-0.0.22/getting-started/movie-quotes-app-tutorial.md",sourceDirName:"getting-started",slug:"/getting-started/movie-quotes-app-tutorial",permalink:"/docs/0.0.22/getting-started/movie-quotes-app-tutorial",draft:!1,tags:[],version:"0.0.22",frontMatter:{},sidebar:"docs",previous:{title:"Quick Start Guide",permalink:"/docs/0.0.22/getting-started/quick-start-guide"},next:{title:"Architecture",permalink:"/docs/0.0.22/getting-started/architecture"}},s={},p=[{value:"What we&#39;re going to cover",id:"what-were-going-to-cover",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Build the backend",id:"build-the-backend",level:2},{value:"Create a Platformatic API",id:"create-a-platformatic-api",level:3},{value:"Define the database schema",id:"define-the-database-schema",level:3},{value:"Create an entity relationship",id:"create-an-entity-relationship",level:3},{value:"Populate the database",id:"populate-the-database",level:3},{value:"Build the frontend",id:"build-the-frontend",level:2},{value:"Create an Astro application",id:"create-an-astro-application",level:3},{value:"Create a layout",id:"create-a-layout",level:3},{value:"Integrate the urql GraphQL client",id:"integrate-the-urql-graphql-client",level:3},{value:"Display all quotes",id:"display-all-quotes",level:3},{value:"Integrate Tailwind for styling",id:"integrate-tailwind-for-styling",level:3},{value:"Style the listing page",id:"style-the-listing-page",level:3},{value:"Create an add quote page",id:"create-an-add-quote-page",level:3},{value:"Send form data to the API",id:"send-form-data-to-the-api",level:3},{value:"Add autosuggest for movies",id:"add-autosuggest-for-movies",level:3},{value:"Create an edit quote page",id:"create-an-edit-quote-page",level:3},{value:"Add delete quote functionality",id:"add-delete-quote-functionality",level:3},{value:"Build a &quot;like&quot; quote feature",id:"build-a-like-quote-feature",level:2},{value:"Create an API migration",id:"create-an-api-migration",level:3},{value:"Create an API plugin",id:"create-an-api-plugin",level:3},{value:"Add a REST API route",id:"add-a-rest-api-route",level:3},{value:"Add a GraphQL API mutation",id:"add-a-graphql-api-mutation",level:3},{value:"Enable CORS on the API",id:"enable-cors-on-the-api",level:3},{value:"Add like quote functionality",id:"add-like-quote-functionality",level:3},{value:"Sort the listing by top quotes",id:"sort-the-listing-by-top-quotes",level:3},{value:"Wrapping up",id:"wrapping-up",level:2}],u={toc:p};function d(e){let{components:t,...n}=e;return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"movie-quotes-app-tutorial"},"Movie Quotes App Tutorial"),(0,o.kt)("p",null,"This tutorial will help you learn how to build a full stack application on top\nof Platformatic DB. We're going to build an application that allows us to\nsave our favourite movie quotes. We'll also be building in custom API functionality\nthat allows for some neat user interaction on our frontend."),(0,o.kt)("p",null,"You can find the complete code for the application that we're going to build\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/platformatic/tutorial-movie-quotes-app"},"on GitHub"),"."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"We'll be building the frontend of our application with the ",(0,o.kt)("a",{parentName:"p",href:"https://astro.build/"},"Astro"),"\nframework, but the GraphQL API integration steps that we're going to cover can\nbe applied with most frontend frameworks.")),(0,o.kt)("h2",{id:"what-were-going-to-cover"},"What we're going to cover"),(0,o.kt)("p",null,"In this tutorial we'll learn how to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create a Platformatic API"),(0,o.kt)("li",{parentName:"ul"},"Apply database migrations"),(0,o.kt)("li",{parentName:"ul"},"Create relationships between our API entities"),(0,o.kt)("li",{parentName:"ul"},"Populate our database tables"),(0,o.kt)("li",{parentName:"ul"},"Build a frontend application that integrates with our GraphQL API"),(0,o.kt)("li",{parentName:"ul"},"Extend our API with custom functionality"),(0,o.kt)("li",{parentName:"ul"},"Enable CORS on our Platformatic API")),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"To follow along with this tutorial you'll need to have these things installed:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://nodejs.org/"},"Node.js")," >= v16.17.0 or >= v18.8.0"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.npmjs.com/cli/"},"npm")," v7 or later"),(0,o.kt)("li",{parentName:"ul"},"A code editor, for example ",(0,o.kt)("a",{parentName:"li",href:"https://code.visualstudio.com/"},"Visual Studio Code"))),(0,o.kt)("p",null,"You'll also need to have some experience with JavaScript, and be comfortable with\nrunning commands in a terminal."),(0,o.kt)("h2",{id:"build-the-backend"},"Build the backend"),(0,o.kt)("h3",{id:"create-a-platformatic-api"},"Create a Platformatic API"),(0,o.kt)("p",null,"First, let's create our project directory:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p tutorial-movie-quotes-app/apps/movie-quotes-api/\n\ncd tutorial-movie-quotes-app/apps/movie-quotes-api/\n")),(0,o.kt)("p",null,"Then let's create a ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm init --yes\n")),(0,o.kt)("p",null,"Now we can install the ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/platformatic"},"platformatic"),"\nCLI as a dependency:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm install platformatic\n")),(0,o.kt)("p",null,"Let's also add some npm run scripts for convenience:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'npm pkg set scripts.start="platformatic db start"\n\nnpm pkg set scripts.dev="npm start"\n')),(0,o.kt)("p",null,"Now we're going to configure our API. Let's create our Platformatic configuration\nfile, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"platformatic.db.json")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "server": {\n    "logger": {\n      "level": "{PLT_SERVER_LOGGER_LEVEL}"\n    },\n    "hostname": "{PLT_SERVER_HOSTNAME}",\n    "port": "{PORT}"\n  },\n  "core": {\n    "connectionString": "{DATABASE_URL}"\n  },\n  "migrations": {\n    "dir": "./migrations"\n  }\n}\n')),(0,o.kt)("p",null,"Now we'll create a ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},".env"))," file with settings for our configuration to use:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PORT=3042\nPLT_SERVER_HOSTNAME=127.0.0.1\nPLT_SERVER_LOGGER_LEVEL=info\nDATABASE_URL=sqlite://./movie-quotes.sqlite\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Take a look at the ",(0,o.kt)("a",{parentName:"p",href:"/docs/0.0.22/reference/configuration"},"Configuration reference"),"\nto see all the supported configuration settings.")),(0,o.kt)("h3",{id:"define-the-database-schema"},"Define the database schema"),(0,o.kt)("p",null,"Let's create a new directory to store our migration files:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir migrations\n")),(0,o.kt)("p",null,"Then we'll create a migration file named ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"001.do.sql"))," in the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"migrations")),"\ndirectory:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE quotes (\n  id INTEGER PRIMARY KEY,\n  quote TEXT NOT NULL,\n  said_by VARCHAR(255) NOT NULL,\n  created_at DATETIME DEFAULT CURRENT_TIMESTAMP\n);\n")),(0,o.kt)("p",null,"Let's also create ",(0,o.kt)("inlineCode",{parentName:"p"},".gitignore")," so that we avoid accidentally committing our\nSQLite database:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"echo '*.sqlite' > .gitignore\n")),(0,o.kt)("p",null,"Now we can start the Platformatic DB server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm run dev\n")),(0,o.kt)("p",null,"Our Platformatic DB server should start, and we'll see messages like these:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'[11:26:48.772] INFO (15235): running 001.do.sql\n[11:26:48.864] INFO (15235): server listening\n    url: "http://127.0.0.1:3042"\n')),(0,o.kt)("p",null,"Let's open a new terminal and make a request to our server's REST API that\ncreates a new quote:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl --request POST --header "Content-Type: application/json" \\\n  -d "{ \\"quote\\": \\"Toto, I\'ve got a feeling we\'re not in Kansas anymore.\\", \\"saidBy\\": \\"Dorothy Gale\\" }" \\\n  http://localhost:3042/quotes\n')),(0,o.kt)("p",null,"We should receive a response like this from the API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{"id":1,"quote":"Toto, I\'ve got a feeling we\'re not in Kansas anymore.","saidBy":"Dorothy Gale","createdAt":"2022-09-13 10:39:35"}\n')),(0,o.kt)("h3",{id:"create-an-entity-relationship"},"Create an entity relationship"),(0,o.kt)("p",null,"Now let's create a migration file named ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"002.do.sql"))," in the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"migrations")),"\ndirectory:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE movies (\n  id INTEGER PRIMARY KEY,\n  name TEXT NOT NULL UNIQUE\n);\n\n-- TODO: Add a foreign key constraint so quotes.movie_id must exist in movies.id\nALTER TABLE quotes ADD COLUMN movie_id INTEGER REFERENCES movies(id);\n")),(0,o.kt)("p",null,"This SQL will create a new ",(0,o.kt)("inlineCode",{parentName:"p"},"movies")," database table and also add a ",(0,o.kt)("inlineCode",{parentName:"p"},"movie_id"),"\ncolumn to the ",(0,o.kt)("inlineCode",{parentName:"p"},"quotes")," table. This will allow us to store movie data in the\n",(0,o.kt)("inlineCode",{parentName:"p"},"movies")," table and then reference them by ID in our ",(0,o.kt)("inlineCode",{parentName:"p"},"quotes")," table."),(0,o.kt)("p",null,"Let's stop the Platformatic DB server with ",(0,o.kt)("inlineCode",{parentName:"p"},"Ctrl + C"),", and then start it again:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm run dev\n")),(0,o.kt)("p",null,"The new migration should be automatically applied and we'll see the log message\n",(0,o.kt)("inlineCode",{parentName:"p"},"running 002.do.sql"),"."),(0,o.kt)("p",null,"Our Platformatic DB server also provides a GraphQL API. Let's open up the GraphiQL\napplication in our web browser:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"http://localhost:3042/graphiql")),(0,o.kt)("p",null,"Now let's run this query with GraphiQL to add the movie for the quote that we\nadded earlier:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql"},'mutation {\n  saveMovie(input: { name: "The Wizard of Oz" }) {\n    id\n  }\n}\n')),(0,o.kt)("p",null,"We should receive a response like this from the API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "data": {\n    "saveMovie": {\n      "id": "1"\n    }\n  }\n}\n')),(0,o.kt)("p",null,"Now we can update our quote to reference the movie:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql"},"mutation {\n  saveQuote(input: { id: 1, movieId: 1 }) {\n    id\n    quote\n    saidBy\n    createdAt\n    movie {\n      id\n      name\n    }\n  }\n}\n")),(0,o.kt)("p",null,"We should receive a response like this from the API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "data": {\n    "saveQuote": {\n      "id": "1",\n      "quote": "Toto, I\'ve got a feeling we\'re not in Kansas anymore.",\n      "saidBy": "Dorothy Gale",\n      "movie": {\n        "id": "1",\n        "name": "The Wizard of Oz"\n      }\n    }\n  }\n}\n')),(0,o.kt)("p",null,"Our Platformatic DB server has automatically identified the relationship\nbetween our ",(0,o.kt)("inlineCode",{parentName:"p"},"quotes")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"movies")," database tables. This allows us to make\nGraphQL queries that retrieve quotes and their associated movies at the same\ntime. For example, to retrieve all quotes from our database we can run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql"},"query {\n  quotes {\n    id\n    quote\n    saidBy\n    createdAt\n    movie {\n      id\n      name\n    }\n  }\n}\n")),(0,o.kt)("p",null,"To view the GraphQL schema that's generated for our API by Platformatic DB,\nwe can run this command in our terminal:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx platformatic db schema graphql\n")),(0,o.kt)("p",null,"The GraphQL schema shows all of the queries and mutations that we can run\nagainst our GraphQL API, as well as the types of data that it expects as input."),(0,o.kt)("h3",{id:"populate-the-database"},"Populate the database"),(0,o.kt)("p",null,'Our movie quotes database is looking a little empty! We\'re going to create a\n"seed" script to populate it with some data.'),(0,o.kt)("p",null,"Let's create a new file named ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"seed.js"))," and copy and paste in this code:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"'use strict'\n\nconst quotes = [\n  {\n    quote: \"Toto, I've got a feeling we're not in Kansas anymore.\",\n    saidBy: 'Dorothy Gale',\n    movie: 'The Wizard of Oz'\n  },\n  {\n    quote: \"You're gonna need a bigger boat.\",\n    saidBy: 'Martin Brody',\n    movie: 'Jaws'\n  },\n  {\n    quote: 'May the Force be with you.',\n    saidBy: 'Han Solo',\n    movie: 'Star Wars'\n  },\n  {\n    quote: 'I have always depended on the kindness of strangers.',\n    saidBy: 'Blanche DuBois',\n    movie: 'A Streetcar Named Desire'\n  }\n]\n\nmodule.exports = async function ({ entities, db, sql }) {\n  for (const values of quotes) {\n    const movie = await entities.movie.save({ input: { name: values.movie } })\n\n    console.log('Created movie:', movie)\n\n    const quote = {\n      quote: values.quote,\n      saidBy: values.saidBy,\n      movieId: movie.id\n    }\n\n    await entities.quote.save({ input: quote })\n\n    console.log('Created quote:', quote)\n  }\n}\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Take a look at the ",(0,o.kt)("a",{parentName:"p",href:"/docs/0.0.22/guides/seed-a-database"},"Seed a Database")," guide to learn more\nabout how database seeding works with Platformatic DB.")),(0,o.kt)("p",null,"Let's stop our Platformatic DB server running and remove our SQLite database:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"rm movie-quotes.db\n")),(0,o.kt)("p",null,"Now let's create a fresh SQLite database by running our migrations:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx platformatic db migrate\n")),(0,o.kt)("p",null,"And then let's populate the ",(0,o.kt)("inlineCode",{parentName:"p"},"quotes")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"movies")," tables with data using our\nseed script:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx platformatic db seed seed.js\n")),(0,o.kt)("p",null,"Our database is full of data, but we don't have anywhere to display it. It's\ntime to start building our frontend!"),(0,o.kt)("h2",{id:"build-the-frontend"},"Build the frontend"),(0,o.kt)("p",null,"We're now going to use ",(0,o.kt)("a",{parentName:"p",href:"https://astro.build/"},"Astro")," to build our frontend\napplication. If you've not used it before, you might find it helpful\nto read ",(0,o.kt)("a",{parentName:"p",href:"https://docs.astro.build/en/core-concepts/astro-components/"},"this overview"),"\non how Astro components are structured."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Astro provide some extensions and tools to help improve your\n",(0,o.kt)("a",{parentName:"p",href:"https://docs.astro.build/en/editor-setup/"},"Editor Setup")," when building an\nAstro application.")),(0,o.kt)("h3",{id:"create-an-astro-application"},"Create an Astro application"),(0,o.kt)("p",null,"In the root of our project, let's create a new directory for our frontent\napplication:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p apps/movie-quotes-frontend/\n\ncd apps/movie-quotes-frontend/\n")),(0,o.kt)("p",null,"And then we'll create a new ",(0,o.kt)("inlineCode",{parentName:"p"},"package.json")," file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm init --yes\n")),(0,o.kt)("p",null,"Now we can install ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/astro"},"astro")," as a dependency:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm install --save-dev astro\n")),(0,o.kt)("p",null,"Then let's set up some npm run scripts for convenience:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'npm pkg delete scripts.test\nnpm pkg set scripts.dev="astro dev --port 3000"\nnpm pkg set scripts.start="astro dev --port 3000"\nnpm pkg set scripts.build="astro build"\n')),(0,o.kt)("p",null,"Now we'll create our Astro configuration file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"astro.config.mjs"))," and\ncopy and paste in this code:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"import { defineConfig } from 'astro/config'\n\n// https://astro.build/config\nexport default defineConfig({\n  output: 'server'\n})\n")),(0,o.kt)("p",null,"And we'll also create a ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"tsconfig.json"))," file and add in this configuration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "extends": "astro/tsconfigs/base",\n  "compilerOptions": {\n    "types": ["astro/client"]\n  }\n}\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"We won't be writing our frontend application with TypeScript, but adding this\nconfiguration file allows Astro to provide TODO\n",(0,o.kt)("a",{parentName:"p",href:"https://docs.astro.build/en/guides/typescript/"},"https://docs.astro.build/en/guides/typescript/"))),(0,o.kt)("p",null,"Now let's create the directories where we'll be adding the components for our\nfrontend application:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p src/pages src/layouts src/components\n")),(0,o.kt)("p",null,"And inside the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages"))," directory let's create our first page, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"index.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"<h1>Movie Quotes</h1>\n")),(0,o.kt)("p",null,"Now we can start up the Astro development server with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm run dev\n")),(0,o.kt)("p",null,"And then load up the frontend in our browser at ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:3000"},"http://localhost:3000")),(0,o.kt)("h3",{id:"create-a-layout"},"Create a layout"),(0,o.kt)("p",null,"In the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/layouts"))," directory, let's create a new file named ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"Layout.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nexport interface Props {\n  title: string;\n  page?: string;\n}\nconst { title, page } = Astro.props;\n---\n\n<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width" />\n    <title>{title}</title>\n  </head>\n  <body>\n    <header>\n      <h1>\ud83c\udfac Movie Quotes</h1>\n    </header>\n    <nav>\n      <a href="/">All quotes</a>\n    </nav>\n    <section>\n      <slot />\n    </section>\n  </body>\n</html>\n')),(0,o.kt)("p",null,"The code between the ",(0,o.kt)("inlineCode",{parentName:"p"},"---")," is known as the component script, and the\ncode after that is the component template. The component script will ",(0,o.kt)("em",{parentName:"p"},"only")," run\non the server side when a web browser makes a request. The component template\nis rendered server side and sent back as an HTML response to the web browser."),(0,o.kt)("p",null,"Now we'll update ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro"))," to use this ",(0,o.kt)("inlineCode",{parentName:"p"},"Layout")," component.\nLet's replace the contents of ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro"))," with this code:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nimport Layout from \'../layouts/Layout.astro\';\n---\n\n<Layout title="All quotes" page="listing">\n  <main>\n    <p>We\'ll list all the movie quotes here.</p>\n  </main>\n</Layout>\n')),(0,o.kt)("h3",{id:"integrate-the-urql-graphql-client"},"Integrate the urql GraphQL client"),(0,o.kt)("p",null,"We're now going to integrate the ",(0,o.kt)("a",{parentName:"p",href:"https://formidable.com/open-source/urql/"},"URQL"),"\nGraphQL client into our frontend application. This will allow us to run queries\nand mutations against our Platformatic GraphQL API."),(0,o.kt)("p",null,"Let's first install ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@urql/core"},"@urql/core")," and\n",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/graphql"},"graphql")," as project dependencies:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm install @urql/core graphql\n")),(0,o.kt)("p",null,"Then let's create a new ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},".env"))," file and add this configuration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PUBLIC_GRAPHQL_API_ENDPOINT=http://127.0.0.1:3042/graphql\n")),(0,o.kt)("p",null,"Now we'll create a new directory:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir src/lib\n")),(0,o.kt)("p",null,"And then create a new file named ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/lib/quotes-api.js")),". In that file we'll\ncreate a new URQL client:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// src/lib/quotes-api.js\n\nimport { createClient } from '@urql/core';\n\nconst graphqlClient = createClient({\n  url: import.meta.env.PUBLIC_GRAPHQL_API_ENDPOINT,\n  requestPolicy: \"network-only\"\n});\n")),(0,o.kt)("p",null,"We'll also add a thin wrapper around the client that does some basic error\nhandling for us:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'// src/lib/quotes-api.js\n\nasync function graphqlClientWrapper(method, gqlQuery, queryVariables = {}) {\n    const queryResult = await graphqlClient[method](\n        gqlQuery,\n        queryVariables\n    ).toPromise();\n\n    if (queryResult.error) {\n        console.error("GraphQL error:", queryResult.error);\n    }\n\n    return {\n        data: queryResult.data,\n        error: queryResult.error,\n    };\n}\n\nexport const quotesApi = {\n    async query(gqlQuery, queryVariables = {}) {\n        return await graphqlClientWrapper("query", gqlQuery, queryVariables);\n    },\n    async mutation(gqlQuery, queryVariables = {}) {\n        return await graphqlClientWrapper("mutation", gqlQuery, queryVariables);\n    }\n}\n')),(0,o.kt)("p",null,"And lastly, we'll export ",(0,o.kt)("inlineCode",{parentName:"p"},"gql")," from the ",(0,o.kt)("inlineCode",{parentName:"p"},"@urql/core")," package, to make it\nsimpler for us to write GraphQL queries in our pages:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'// src/lib/quotes-api.js\n\nexport { gql } from "@urql/core";\n')),(0,o.kt)("p",null,"Stop the Astro dev server and then start it again so it picks up the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},".env")),"\nfile:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm run dev\n")),(0,o.kt)("h3",{id:"display-all-quotes"},"Display all quotes"),(0,o.kt)("p",null,"Let's display all the movie quotes in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro")),"."),(0,o.kt)("p",null,"First, we'll update the component script at the top and add in a query to\nour GraphQL API for quotes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"---\nimport Layout from '../layouts/Layout.astro';\n// highlight-start\nimport { quotesApi, gql } from '../lib/quotes-api';\n\nconst { data } = await quotesApi.query(gql`\n  query {\n    quotes {\n      id\n      quote\n      saidBy\n      createdAt\n      movie {\n        id\n        name\n      }\n    }\n  }\n`);\n\nconst quotes = data?.quotes || [];\n// highlight-end\n---\n")),(0,o.kt)("p",null,"Then we'll update the component template to display the quotes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'<Layout title="All quotes" page="listing">\n  <main>\n// highlight-start\n    {quotes.length > 0 ? quotes.map((quote) => (\n      <div>\n        <blockquote>\n          <p>{quote.quote}</p>\n        </blockquote>\n        <p>\n          \u2014 {quote.saidBy}, {quote.movie?.name}\n        </p>\n        <div>\n          <span>Added {new Date(quote.createdAt).toUTCString()}</span>\n        </div>\n      </div>\n    )) : (\n      <p>No movie quotes have been added.</p>\n    )}\n// highlight-end\n  </main>\n</Layout>\n')),(0,o.kt)("p",null,"And just like that, we have all the movie quotes displaying on the page!"),(0,o.kt)("h3",{id:"integrate-tailwind-for-styling"},"Integrate Tailwind for styling"),(0,o.kt)("p",null,"Automatically add the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.astro.build/en/guides/integrations-guide/tailwind/"},"@astrojs/tailwind integration"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npx astro add tailwind --yes\n")),(0,o.kt)("p",null,"Add the Tailwind CSS ",(0,o.kt)("a",{parentName:"p",href:"https://tailwindcss.com/docs/typography-plugin"},"Typography"),"\nand ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/tailwindlabs/tailwindcss-forms"},"Forms")," plugins:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm install --save-dev @tailwindcss/typography @tailwindcss/forms\n")),(0,o.kt)("p",null,"Import the plugins in our Tailwind configuration file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// tailwind.config.cjs\n\n/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: ['./src/**/*.{astro,html,js,jsx,md,mdx,svelte,ts,tsx,vue}'],\n  theme: {\n    extend: {}\n  },\n// highlight-start\n  plugins: [\n    require('@tailwindcss/forms'),\n    require('@tailwindcss/typography')\n  ]\n// highlight-end\n}\n")),(0,o.kt)("p",null,"Stop the Astro dev server and then start it again so it picks up all the\nconfiguration changes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm run dev\n")),(0,o.kt)("h3",{id:"style-the-listing-page"},"Style the listing page"),(0,o.kt)("p",null,"To style our listing page, let's add CSS classes to the component template in\n",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/layouts/Layout.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nexport interface Props {\n    title: string;\n    page?: string;\n}\n\nconst { title, page } = Astro.props;\n\n// highlight-next-line\nconst navActiveClasses = "font-bold bg-yellow-400 no-underline";\n---\n\n<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width" />\n    <title>{title}</title>\n  </head>\n// highlight-next-line\n  <body class="py-8">\n// highlight-next-line\n    <header class="prose mx-auto mb-6">\n      <h1>\ud83c\udfac Movie Quotes</h1>\n    </header>\n// highlight-next-line\n    <nav class="prose mx-auto mb-6 border-y border-gray-200 flex">\n// highlight-next-line\n      <a href="/" class={`p-3 ${page === "listing" && navActiveClasses}`}>All quotes</a>\n    </nav>\n// highlight-next-line\n    <section class="prose mx-auto">\n      <slot />\n    </section>\n  </body>\n</html>\n')),(0,o.kt)("p",null,"Then let's add CSS classes to the component template in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'<Layout title="All quotes">\n  <main>\n    {quotes.length > 0 ? quotes.map((quote) => (\n// highlight-next-line\n      <div class="border-b mb-6">\n// highlight-next-line\n        <blockquote class="text-2xl mb-0">\n// highlight-next-line\n          <p class="mb-4">{quote.quote}</p>\n        </blockquote>\n// highlight-next-line\n        <p class="text-xl mt-0 mb-8 text-gray-400">\n          \u2014 {quote.saidBy}, {quote.movie?.name}\n        </p>\n// highlight-next-line\n        <div class="flex flex-col mb-6 text-gray-400">\n// highlight-next-line\n          <span class="text-gray-400 italic">Added {new Date(quote.createdAt).toUTCString()}</span>\n        </div>\n      </div>\n    )) : (\n      <p>No movie quotes have been added.</p>\n    )}\n  </main>\n</Layout>\n')),(0,o.kt)("p",null,"Our listing page is now looking much more user friendly!"),(0,o.kt)("h3",{id:"create-an-add-quote-page"},"Create an add quote page"),(0,o.kt)("p",null,"We're going to create a form component that we can use for adding and editing\nquotes."),(0,o.kt)("p",null,"First let's create a new component file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/components/QuoteForm.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nexport interface QuoteFormData {\n  id?: number;\n  quote?: string;\n  saidBy?: string;\n  movie?: string;\n}\n\nexport interface Props {\n  action: string;\n  values?: QuoteFormData;\n  saveError?: boolean;\n  loadError?: boolean;\n  submitLabel: string;\n}\n\nconst { action, values = {}, saveError, loadError, submitLabel } = Astro.props;\n---\n\n{saveError && <p class="text-lg bg-red-200 p-4">There was an error saving the quote. Please try again.</p>}\n{loadError && <p class="text-lg bg-red-200 p-4">There was an error loading the quote. Please try again.</p>}\n\n<form method="post" action={action} class="grid grid-cols-1 gap-6">\n  <label for="quote" class="block">\n    <span>Quote</span>\n    <textarea id="quote" name="quote" required="required" class="mt-1 w-full">{values.quote}</textarea>\n  </label>\n  <label for="said-by" class="block">\n    <span>Said by</span>\n    <input type="text" id="said-by" name="saidBy" required="required" value={values.saidBy} class="mt-1 w-full">\n  </label>\n  <label for="movie" class="block">\n    <span>Movie</span>\n    <input type="text" id="movie" name="movie" required="required" autocomplete="off" value={values.movie} class="form-input mt-1 w-full">\n  </label>\n  <input type="submit" value={submitLabel} disabled={loadError && "disabled"} class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 round p-3" />\n</form>\n')),(0,o.kt)("p",null,"Create a new page file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/add.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nimport Layout from \'../layouts/Layout.astro\';\nimport QuoteForm from \'../components/QuoteForm.astro\';\nimport type { QuoteFormData } from \'../components/QuoteForm.astro\';\n\nlet formData: QuoteFormData = {};\nlet saveError = false;\n---\n\n<Layout title="Add a movie quote" page="add">\n  <main>\n    <h2>Add a quote</h2>\n    <QuoteForm action="/add" values={formData} saveError={saveError} submitLabel="Add quote" />\n  </main>\n</Layout>\n')),(0,o.kt)("p",null,"And now let's add a link to this page in the layout navigation in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/layouts/Layout.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'<nav class="prose mx-auto mb-6 border-y border-gray-200 flex">\n  <a href="/" class={`p-3 ${page === "listing" && navActiveClasses}`}>All quotes</a>\n// highlight-next-line\n  <a href="/add" class={`p-3 ${page === "add" && navActiveClasses}`}>Add a quote</a>\n</nav>\n')),(0,o.kt)("h3",{id:"send-form-data-to-the-api"},"Send form data to the API"),(0,o.kt)("p",null,"When a user submits the add quote form we want to send the form data to our API\nso it can then save it to our database. Let's wire that up now."),(0,o.kt)("p",null,"First we're going to create a new file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/lib/request-utils.js")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"export function isPostRequest (request) {\n  return request.method === 'POST'\n}\n\nexport async function getFormData (request) {\n  const formData = await request.formData()\n\n  return Object.fromEntries(formData.entries())\n}\n")),(0,o.kt)("p",null,"Then let's update the component script in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/add.astro"))," to use\nthese new request utility functions:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"---\nimport Layout from '../layouts/Layout.astro';\nimport QuoteForm from '../components/QuoteForm.astro';\nimport type { QuoteFormData } from '../components/QuoteForm.astro';\n\n// highlight-next-line\nimport { isPostRequest, getFormData } from '../lib/request-utils';\n\nlet formData: QuoteFormData = {};\nlet saveError = false;\n\n// highlight-start\nif (isPostRequest(Astro.request)) {\n  formData = await getFormData(Astro.request);\n}\n// highlight-end\n---\n")),(0,o.kt)("p",null,"When we create a new quote entity record via our API, we need to include a\n",(0,o.kt)("inlineCode",{parentName:"p"},"movieId")," field that references a movie entity record. This means that when a\nuser submits the add quote form we need to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Check if a movie entity record already exists with that movie name"),(0,o.kt)("li",{parentName:"ul"},"Return the movie ",(0,o.kt)("inlineCode",{parentName:"li"},"id")," if it does exist"),(0,o.kt)("li",{parentName:"ul"},"If it doesn't exist, create a new movie entity record and return the movie ID")),(0,o.kt)("p",null,"Let's update the ",(0,o.kt)("inlineCode",{parentName:"p"},"import")," statement at the top of ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/lib/quotes-api.js"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-diff"},"-import { createClient } from '@urql/core'\n+import { createClient, gql } from '@urql/core'\n")),(0,o.kt)("p",null,"And then add a new method that will return a movie ID for us:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"async function getMovieId (movieName) {\n  movieName = movieName.trim()\n\n  let movieId = null\n\n  // Check if a movie already exists with the provided name.\n  const queryMoviesResult = await quotesApi.query(\n    gql`\n      query ($movieName: String!) {\n        movies(where: { name: { eq: $movieName } }) {\n          id\n        }\n      }\n    `,\n    { movieName }\n  )\n\n  if (queryMoviesResult.error) {\n    return null\n  }\n\n  const movieExists = queryMoviesResult.data?.movies.length === 1\n  if (movieExists) {\n    movieId = queryMoviesResult.data.movies[0].id\n  } else {\n    // Create a new movie entity record.\n    const saveMovieResult = await quotesApi.mutation(\n      gql`\n        mutation ($movieName: String!) {\n          saveMovie(input: { name: $movieName }) {\n            id\n          }\n        }\n      `,\n      { movieName }\n    )\n\n    if (saveMovieResult.error) {\n      return null\n    }\n\n    movieId = saveMovieResult.data?.saveMovie.id\n  }\n\n  return movieId\n}\n")),(0,o.kt)("p",null,"And let's export it too:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"export const quotesApi = {\n  async query (gqlQuery, queryVariables = {}) {\n    return await graphqlClientWrapper('query', gqlQuery, queryVariables)\n  },\n  async mutation (gqlQuery, queryVariables = {}) {\n    return await graphqlClientWrapper('mutation', gqlQuery, queryVariables)\n  },\n// highlight-next-line\n  getMovieId\n}\n")),(0,o.kt)("p",null,"Now we can wire up the last parts in the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/add.astro"))," component\nscript:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"---\nimport Layout from '../layouts/Layout.astro';\nimport QuoteForm from '../components/QuoteForm.astro';\nimport type { QuoteFormData } from '../components/QuoteForm.astro';\n\n// highlight-next-line\nimport { quotesApi, gql } from '../lib/quotes-api';\nimport { isPostRequest, getFormData } from '../lib/request-utils';\n\nlet formData: QuoteFormData = {};\nlet saveError = false;\n\nif (isPostRequest(Astro.request)) {\n  formData = await getFormData(Astro.request);\n\n// highlight-start\n  const movieId = await quotesApi.getMovieId(formData.movie);\n\n  if (movieId) {\n    const quote = {\n      quote: formData.quote,\n      saidBy: formData.saidBy,\n      movieId,\n    };\n\n    const { error } = await quotesApi.mutation(gql`\n      mutation($quote: QuoteInput!) {\n        saveQuote(input: $quote) {\n          id\n        }\n      }\n    `, { quote });\n\n    if (!error) {\n      return Astro.redirect('/');\n    } else {\n      saveError = true;\n    }\n  } else {\n    saveError = true;\n  }\n// highlight-end\n}\n")),(0,o.kt)("h3",{id:"add-autosuggest-for-movies"},"Add autosuggest for movies"),(0,o.kt)("p",null,"We can create a better experience for our users by autosuggesting the movie name\nwhen they're adding a new quote."),(0,o.kt)("p",null,"Let's open up ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/components/QuoteForm.astro"))," and import our API helper methods\nin the component script:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"import { quotesApi, gql } from '../lib/quotes-api.js';\n")),(0,o.kt)("p",null,"Then let's add in a query to our GraphQL API for all movies:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"const { data } = await quotesApi.query(gql`\n  query {\n    movies {\n      name\n    }\n  }\n`);\n\nconst movies = data?.movies || [];\n")),(0,o.kt)("p",null,"Now lets update the ",(0,o.kt)("em",{parentName:"p"},"Movie")," field in the component template to use the\narray of movies that we've retrieved from the API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'<label for="movie" class="block">\n  <span>Movie</span>\n// highlight-start\n  <input list="movies" id="movie" name="movie" required="required" autocomplete="off" value={values.movie} class="form-input mt-1 w-full">\n  <datalist id="movies">\n    {movies.map(({ name }) => (\n      <option>{name}</option>\n    ))}\n  </datalist>\n// highlight-end\n</label>\n')),(0,o.kt)("h3",{id:"create-an-edit-quote-page"},"Create an edit quote page"),(0,o.kt)("p",null,"Let's create a new directory, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/edit/")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir src/pages/edit/\n")),(0,o.kt)("p",null,"And inside of it, let's create a new page, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"[id].astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"---\nimport Layout from '../../layouts/Layout.astro';\nimport QuoteForm, { QuoteFormData } from '../../components/QuoteForm.astro';\n\nconst id = Number(Astro.params.id);\n\nlet formValues: QuoteFormData = {};\nlet loadError = false;\nlet saveError = false;\n---\n\n<Layout title=\"Edit movie quote\">\n  <main>\n    <h2>Edit quote</h2>\n    <QuoteForm action={`/edit/${id}`} values={formValues} saveError={saveError} loadError={loadError} submitLabel=\"Update quote\" />\n  </main>\n</Layout>\n")),(0,o.kt)("p",null,"You'll see that we're using the same ",(0,o.kt)("inlineCode",{parentName:"p"},"QuoteForm")," component that our add quote\npage uses. Now we're going to wire up our edit page so that it can load an\nexisting quote from our API and save changes back to the API when the form is\nsubmitted."),(0,o.kt)("p",null,"In the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"[id.astro]"))," component script, let's add some code to take care of\nthese tasks:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"---\nimport Layout from '../../layouts/Layout.astro';\nimport QuoteForm, { QuoteFormData } from '../../components/QuoteForm.astro';\n\n// highlight-start\nimport { quotesApi, gql } from '../../lib/quotes-api';\nimport { isPostRequest, getFormData } from '../../lib/request-utils';\n// highlight-end\n\nconst id = Number(Astro.params.id);\n\nlet formValues: QuoteFormData = {};\nlet loadError = false;\nlet saveError = false;\n\n// highlight-start\nif (isPostRequest(Astro.request)) {\n  const formData = await getFormData(Astro.request);\n  formValues = formData;\n\n  const movieId = await quotesApi.getMovieId(formData.movie);\n\n  if (movieId) {\n    const quote = {\n      id,\n      quote: formData.quote,\n      saidBy: formData.saidBy,\n      movieId,\n    };\n\n    const { error } = await quotesApi.mutation(gql`\n      mutation($quote: QuoteInput!) {\n        saveQuote(input: $quote) {\n          id\n        }\n      }\n    `, { quote });\n\n    if (!error) {\n      return Astro.redirect('/');\n    } else {\n      saveError = true;\n    }\n  } else {\n    saveError = true;\n  }\n} else {\n  const { data } = await quotesApi.query(gql`\n    query($id: ID!) {\n      getQuoteById(id: $id) {\n        id\n        quote\n        saidBy\n        movie {\n          id\n          name\n        }\n      }\n    }\n  `, { id });\n\n  if (data?.getQuoteById) {\n    formValues = {\n      ...data.getQuoteById,\n      movie: data.getQuoteById.movie.name\n    };\n  } else {\n    loadError = true;\n  }\n}\n// highlight-end\n---\n")),(0,o.kt)("p",null,"Load up ",(0,o.kt)("a",{parentName:"p",href:"http://localhost:3000/edit/1"},"http://localhost:3000/edit/1")," in your\nbrowser to test out the edit quote page."),(0,o.kt)("p",null,"Now we're going to add edit links to the quotes listing page. Let's start by\ncreating a new component ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/components/QuoteActionEdit.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nexport interface Props {\n  id: number;\n}\n\nconst { id } = Astro.props;\n---\n<a href={`/edit/${id}`} class="flex items-center mr-5 text-gray-400 hover:text-yellow-600 underline decoration-yellow-600 decoration-2 underline-offset-4">\n  <svg class="w-6 h-6 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">\n    <path d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32l8.4-8.4z" />\n    <path d="M5.25 5.25a3 3 0 00-3 3v10.5a3 3 0 003 3h10.5a3 3 0 003-3V13.5a.75.75 0 00-1.5 0v5.25a1.5 1.5 0 01-1.5 1.5H5.25a1.5 1.5 0 01-1.5-1.5V8.25a1.5 1.5 0 011.5-1.5h5.25a.75.75 0 000-1.5H5.25z" />\n  </svg>\n  <span class="hover:underline hover:decoration-yellow-600">Edit</span>\n</a>\n')),(0,o.kt)("p",null,"Then let's import this component and use it in our listing page,\n",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nimport Layout from \'../layouts/Layout.astro\';\n// highlight-next-line\nimport QuoteActionEdit from \'../components/QuoteActionEdit.astro\';\nimport { quotesApi, gql } from \'../lib/quotes-api\';\n\n// ...\n---\n\n<Layout title="All quotes" page="listing">\n  <main>\n    {quotes.length > 0 ? quotes.map((quote) => (\n      <div class="border-b mb-6">\n        ...\n        <div class="flex flex-col mb-6 text-gray-400">\n// highlight-start\n          <span class="flex items-center">\n            <QuoteActionEdit id={quote.id} />\n          </span>\n          <span class="mt-4 text-gray-400 italic">Added {new Date(quote.createdAt).toUTCString()}</span>\n// highlight-end\n        </div>\n      </div>\n    )) : (\n      <p>No movie quotes have been added.</p>\n    )}\n  </main>\n</Layout>\n')),(0,o.kt)("h3",{id:"add-delete-quote-functionality"},"Add delete quote functionality"),(0,o.kt)("p",null,"Our Movie Quotes app can create, retrieve and update quotes. Now we're going\nto implement the D in CRUD \u2014 delete!"),(0,o.kt)("p",null,"First let's create a new component, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/components/QuoteActionDelete.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nexport interface Props {\n  id: number;\n}\n\nconst { id } = Astro.props;\n---\n<form method="POST" action={`/delete/${id}`} class="form-delete-quote m-0">\n  <button type="submit" class="flex items-center text-gray-400 hover:text-red-700 underline decoration-red-700 decoration-2 underline-offset-4">\n    <svg class="w-6 h-6 mr-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">\n      <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" />\n    </svg>\n    <span>Delete</span>\n  </button>\n</form>\n')),(0,o.kt)("p",null,"And then we'll drop it into our listing page, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nimport Layout from \'../layouts/Layout.astro\';\nimport QuoteActionEdit from \'../components/QuoteActionEdit.astro\';\n// highlight-next-line\nimport QuoteActionDelete from \'../components/QuoteActionDelete.astro\';\nimport { quotesApi, gql } from \'../lib/quotes-api\';\n\n// ...\n---\n\n<Layout title="All quotes" page="listing">\n  <main>\n    {quotes.length > 0 ? quotes.map((quote) => (\n      <div class="border-b mb-6">\n        ...\n        <div class="flex flex-col mb-6 text-gray-400">\n          <span class="flex items-center">\n            <QuoteActionEdit id={quote.id} />\n// highlight-next-line\n            <QuoteActionDelete id={quote.id} />\n          </span>\n          <span class="mt-4 text-gray-400 italic">Added {new Date(quote.createdAt).toUTCString()}</span>\n        </div>\n      </div>\n...\n')),(0,o.kt)("p",null,"At the moment when a delete form is submitted from our listing page, we get\nan Astro 404 page. Let's fix this by creating a new directory, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/delete/")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir src/pages/delete/\n")),(0,o.kt)("p",null,"And inside of it, let's create a new page, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"[id].astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"---\nimport Layout from '../../layouts/Layout.astro';\n\nimport { quotesApi, gql } from '../../lib/quotes-api';\nimport { isPostRequest } from '../../lib/request-utils';\n\nif (isPostRequest(Astro.request)) {\n  const id = Number(Astro.params.id);\n\n  const { error } = await quotesApi.mutation(gql`\n    mutation($id: ID!) {\n      deleteQuotes(where: { id: { eq: $id }}) {\n        id\n      }\n    }\n  `, { id });\n\n  if (!error) {\n    return Astro.redirect('/');\n  }\n}\n---\n<Layout title=\"Delete movie quote\">\n  <main>\n    <h2>Delete quote</h2>\n    <p class=\"text-lg bg-red-200 p-4\">There was an error deleting the quote. Please try again.</p>\n  </main>\n</Layout>\n")),(0,o.kt)("p",null,"Now if we click on a delete quote button on our listings page, it should call our\nGraphQL API to delete the quote. To make this a little more user friendly, let's\nadd in a confirmation dialog so that users don't delete a quote by accident."),(0,o.kt)("p",null,"Let's create a new directory, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/scripts/")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir src/scripts/\n")),(0,o.kt)("p",null,"And inside of that directory let's create a new file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"quote-actions.js")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// src/scripts/quote-actions.js\n\nexport function confirmDeleteQuote (form) {\n  if (confirm('Are you sure want to delete this quote?')) {\n    form.submit()\n  }\n}\n")),(0,o.kt)("p",null,"Then we can pull it in as client side JavaScript on our listing page,\n",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},"<Layout>\n  ...\n</Layout>\n\n<script>\n  import { confirmDeleteQuote } from '../scripts/quote-actions.js'\n\n  addEventListener('DOMContentLoaded', () => {\n    document.querySelectorAll('.form-delete-quote').forEach((deleteForm) => {\n      deleteForm.addEventListener('submit', (event) => {\n        event.preventDefault()\n        confirmDeleteQuote(event.currentTarget)\n      })\n    })\n  })\n<\/script>\n")),(0,o.kt)("h2",{id:"build-a-like-quote-feature"},'Build a "like" quote feature'),(0,o.kt)("p",null,"We've built all the basic CRUD (Create, Retrieve, Update & Delete) features\ninto our application. Now let's build a feature so that users can interact\nand \"like\" their favourite movie quotes."),(0,o.kt)("p",null,"To build this feature we're going to add custom functionality to our API\nand then add a new component, along with some client side JavaScript, to\nour frontend."),(0,o.kt)("h3",{id:"create-an-api-migration"},"Create an API migration"),(0,o.kt)("p",null,"We're now going to work on the code for API, under the ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"apps/movie-quotes-api")),"\ndirectory."),(0,o.kt)("p",null,"First let's create a migration that adds a ",(0,o.kt)("inlineCode",{parentName:"p"},"likes")," column to our ",(0,o.kt)("inlineCode",{parentName:"p"},"quotes"),"\ndatabase table. We'll create a new migration file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"migrations/003.do.sql")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE quotes ADD COLUMN likes INTEGER default 0;\n")),(0,o.kt)("p",null,"This migration will automatically be applied when we next start our Platformatic\nAPI."),(0,o.kt)("h3",{id:"create-an-api-plugin"},"Create an API plugin"),(0,o.kt)("p",null,"To add custom functionality to our Platformatic API, we need to create a\n",(0,o.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Reference/Plugins/"},"Fastify plugin")," and\nupdate our API configuration to use it."),(0,o.kt)("p",null,"Let's create a new file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"plugin.js")),", and inside it we'll add the skeleton\nstructure for our plugin:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// plugin.js\n\n'use strict'\n\nmodule.exports = async function plugin (app) {\n  app.log.info('plugin loaded')\n}\n")),(0,o.kt)("p",null,"Now let's register our plugin in our API configuration file, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"platformatic.db.json")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  ...\n  "migrations": {\n    "dir": "./migrations"\n// highlight-start\n  },\n  "plugin": {\n    "path": "./plugin.js"\n  }\n// highlight-end\n}\n')),(0,o.kt)("p",null,"And then we'll start up our Platformatic API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm run dev\n")),(0,o.kt)("p",null,"We should see log messages that tell us that our new migration has been\napplied and our plugin has been loaded:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'[10:09:20.052] INFO (146270): running 003.do.sql\n[10:09:20.129] INFO (146270): plugin loaded\n[10:09:20.209] INFO (146270): server listening\n    url: "http://127.0.0.1:3042"\n')),(0,o.kt)("p",null,"Now it's time to start adding some custom functionality inside our plugin."),(0,o.kt)("h3",{id:"add-a-rest-api-route"},"Add a REST API route"),(0,o.kt)("p",null,"We're going to add a REST route to our API that increments the count of\nlikes for a specific quote: ",(0,o.kt)("inlineCode",{parentName:"p"},"/quotes/:id/like")),(0,o.kt)("p",null,"First let's add ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/fluent-json-schema"},"fluent-json-schema")," as a dependency for our API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"npm install fluent-json-schema\n")),(0,o.kt)("p",null,"We'll use ",(0,o.kt)("inlineCode",{parentName:"p"},"fluent-json-schema")," to help us generate a JSON Schema. We can then\nuse this schema to validate the request path parameters for our route (",(0,o.kt)("inlineCode",{parentName:"p"},"id"),")."),(0,o.kt)("p",null,"Now let's add our REST API route in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"plugin.js")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"'use strict'\n\n// highlight-next-line\nconst S = require('fluent-json-schema')\n\nmodule.exports = async function plugin (app) {\n  app.log.info('plugin loaded')\n\n  // This JSON Schema will validate the request path parameters.\n  // It reuses part of the schema that Platormatic DB has\n  // automatically generated for our Quote entity.\n// highlight-start\n  const schema = {\n    params: S.object().prop('id', app.getSchema('Quote').properties.id)\n  }\n\n  app.post('/quotes/:id/like', { schema }, async function (request, response) {\n    return {}\n  })\n// highlight-end\n}\n")),(0,o.kt)("p",null,"We can now make a ",(0,o.kt)("inlineCode",{parentName:"p"},"POST")," request to our new API route:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"curl --request POST http://localhost:3042/quotes/1/like\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Learn more about how validation works in the\n",(0,o.kt)("a",{parentName:"p",href:"https://www.fastify.io/docs/latest/Reference/Validation-and-Serialization/"},"Fastify validation documentation"),".")),(0,o.kt)("p",null,"Our API route is currently returning an empty object (",(0,o.kt)("inlineCode",{parentName:"p"},"{}"),"). Let's wire things\nup so that it increments the number of likes for the quote with the specified ID.\nTo do this we'll add a new function inside of our plugin:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports = async function plugin (app) {\n  app.log.info('plugin loaded')\n\n// highlight-start\n  async function incrementQuoteLikes (id) {\n    const { db, sql } = app.platformatic\n\n    const result = await db.query(sql`\n      UPDATE quotes SET likes = likes + 1 WHERE id=${id} RETURNING likes\n    `)\n\n    return result[0]?.likes\n  }\n// highlight-end\n\n  // ...\n}\n")),(0,o.kt)("p",null,"And then we'll call that function in our route handler function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"app.post('/quotes/:id/like', { schema }, async function (request, response) {\n// highlight-next-line\n  return { likes: await incrementQuoteLikes(request.params.id) }\n})\n")),(0,o.kt)("p",null,"Now when we make a ",(0,o.kt)("inlineCode",{parentName:"p"},"POST")," request to our API route:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"curl --request POST http://localhost:3042/quotes/1/like\n")),(0,o.kt)("p",null,"We should see that the ",(0,o.kt)("inlineCode",{parentName:"p"},"likes")," value for the quote is incremented every time\nwe make a request to the route."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{"likes":1}\n')),(0,o.kt)("h3",{id:"add-a-graphql-api-mutation"},"Add a GraphQL API mutation"),(0,o.kt)("p",null,"We can add a ",(0,o.kt)("inlineCode",{parentName:"p"},"likeQuote")," mutation to our GraphQL API by reusing the\n",(0,o.kt)("inlineCode",{parentName:"p"},"incrementQuoteLikes")," function that we just created."),(0,o.kt)("p",null,"Let's add this code at the end of our plugin, inside ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"plugin.js")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"module.exports = async function plugin (app) {\n  // ...\n\n// highlight-start\n  app.graphql.extendSchema(`\n    extend type Mutation {\n      likeQuote(id: ID!): Int\n    }\n  `)\n\n  app.graphql.defineResolvers({\n    Mutation: {\n      likeQuote: async (_, { id }) => await incrementQuoteLikes(id)\n    }\n  })\n// highlight-end\n}\n")),(0,o.kt)("p",null,"The code we've just added extends our API's GraphQL schema and defines\na corresponding resolver for the ",(0,o.kt)("inlineCode",{parentName:"p"},"likeQuote")," mutation."),(0,o.kt)("p",null,"We can now load up GraphiQL in our web browser and try out our new ",(0,o.kt)("inlineCode",{parentName:"p"},"likeQuote"),"\nmutation with this GraphQL query:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-graphql"},"mutation {\n  likeQuote(id: 1)\n}\n")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Learn more about how to extend the GraphQL schema and define resolvers in the\n",(0,o.kt)("a",{parentName:"p",href:"https://mercurius.dev/#/docs/api/options"},"Mercurius API documentation"),".")),(0,o.kt)("h3",{id:"enable-cors-on-the-api"},"Enable CORS on the API"),(0,o.kt)("p",null,'When we build "like" functionality into our frontend, we\'ll be making a client\nside HTTP request to our GraphQL API. Our backend API and our frontend are running\non different origins, so we need to configure our API to allow requests from\nthe frontend. This is known as Cross-Origin Resource Sharing (CORS).'),(0,o.kt)("p",null,"To enable CORS on our API, let's open up our API's ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},".env"))," file and add in\na new setting:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"PLT_SERVER_CORS_ORIGIN=http://localhost:3000\n")),(0,o.kt)("p",null,"The value of ",(0,o.kt)("inlineCode",{parentName:"p"},"PLT_SERVER_CORS_ORIGIN")," is our frontend application's origin."),(0,o.kt)("p",null,"Now we can add a ",(0,o.kt)("inlineCode",{parentName:"p"},"cors")," configuration object in our API's configuration file,\n",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"platformatic.db.json")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "server": {\n    "logger": {\n      "level": "{PLT_SERVER_LOGGER_LEVEL}"\n    },\n    "hostname": "{PLT_SERVER_HOSTNAME}",\n    "port": "{PORT}",\n// highlight-start\n    "cors": {\n      "origin": "{PLT_SERVER_CORS_ORIGIN}"\n    }\n// highlight-end\n  },\n  ...\n}\n')),(0,o.kt)("p",null,"The HTTP responses from all endpoints on our API will now include the header:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"access-control-allow-origin: http://localhost:3000\n")),(0,o.kt)("p",null,"This will allow JavaScript running on web pages under the ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:3000"),"\norigin to make requests to our API."),(0,o.kt)("h3",{id:"add-like-quote-functionality"},"Add like quote functionality"),(0,o.kt)("p",null,'Now that our API supports "liking" a quote, let\'s integrate it as a feature in\nour frontend.'),(0,o.kt)("p",null,"First we'll create a new component, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/components/QuoteActionLike.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nexport interface Props {\n  id: number;\n  likes: number;\n}\n\nconst { id, likes } = Astro.props;\n---\n<span data-quote-id={id} class="like-quote cursor-pointer mr-5 flex items-center">\n  <svg class="like-icon w-6 h-6 mr-2 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">\n    <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />\n  </svg>\n  <span class="likes-count w-8">{likes}</span>\n</span>\n\n<style>\n  .like-quote:hover .like-icon,\n  .like-quote.liked .like-icon {\n    fill: currentColor;\n  }\n</style>\n')),(0,o.kt)("p",null,"And in our listing page, ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro")),", let's import our new\ncomponent and add it into the interface:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\nimport Layout from \'../layouts/Layout.astro\';\nimport QuoteActionEdit from \'../components/QuoteActionEdit.astro\';\nimport QuoteActionDelete from \'../components/QuoteActionDelete.astro\';\n// highlight-next-line\nimport QuoteActionLike from \'../components/QuoteActionLike.astro\';\nimport { quotesApi, gql } from \'../lib/quotes-api\';\n\n// ...\n---\n\n<Layout title="All quotes" page="listing">\n  <main>\n    {quotes.length > 0 ? quotes.map((quote) => (\n      <div class="border-b mb-6">\n        ...\n        <div class="flex flex-col mb-6 text-gray-400">\n          <span class="flex items-center">\n// highlight-next-line\n            <QuoteActionLike id={quote.id} likes={quote.likes} />\n            <QuoteActionEdit id={quote.id} />\n            <QuoteActionDelete id={quote.id} />\n          </span>\n          <span class="mt-4 text-gray-400 italic">Added {new Date(quote.createdAt).toUTCString()}</span>\n        </div>\n      </div>\n...\n')),(0,o.kt)("p",null,"Then let's update the GraphQL query in this component's script to retrieve the\n",(0,o.kt)("inlineCode",{parentName:"p"},"likes")," field for all quotes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"const { data } = await quotesApi.query(gql`\n  query {\n    quotes {\n      id\n      quote\n      saidBy\n// highlight-next-line\n      likes\n      createdAt\n      movie {\n        id\n        name\n      }\n    }\n  }\n`);\n")),(0,o.kt)("p",null,"Now we have the likes showing for each quote, let's wire things up so that\nclicking on the like component for a quote will call our API and add a like."),(0,o.kt)("p",null,"Let's open up ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/scripts/quote-actions.js"))," and add a new function that\nmakes a request to our GraphQL API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"// highlight-next-line\nimport { quotesApi, gql } from '../lib/quotes-api.js'\n\nexport function confirmDeleteQuote (form) {\n  if (confirm('Are you sure want to delete this quote?')) {\n    form.submit()\n  }\n}\n\n// highlight-start\nexport async function likeQuote (likeQuote) {\n  likeQuote.classList.add('liked')\n  likeQuote.classList.remove('cursor-pointer')\n\n  const id = Number(likeQuote.dataset.quoteId)\n\n  const { data } = await quotesApi.mutation(gql`\n    mutation($id: ID!) {\n      likeQuote(id: $id)\n    }\n  `, { id })\n\n  if (data?.likeQuote) {\n    likeQuote.querySelector('.likes-count').innerText = data.likeQuote\n  }\n}\n// highlight-end\n")),(0,o.kt)("p",null,"And then let's attach the ",(0,o.kt)("inlineCode",{parentName:"p"},"likeQuote")," function to the click event for each\nlike quote component on our listing page. We can do this by adding a little\nextra code inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"<script>")," block in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro")),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-html"},"<script>\n// highlight-next-line\n  import { confirmDeleteQuote, likeQuote } from '../scripts/quote-actions.js'\n\n  addEventListener('DOMContentLoaded', () => {\n    document.querySelectorAll('.form-delete-quote').forEach((deleteForm) => {\n      deleteForm.addEventListener('submit', (event) => {\n        event.preventDefault()\n        confirmDeleteQuote(event.currentTarget)\n      })\n    })\n\n// highlight-start\n    document.querySelectorAll('.like-quote').forEach((container) => {\n      container.addEventListener('click', (event) => likeQuote(event.currentTarget), { once: true })\n    })\n// highlight-end\n  })\n<\/script>\n")),(0,o.kt)("h3",{id:"sort-the-listing-by-top-quotes"},"Sort the listing by top quotes"),(0,o.kt)("p",null,"Now that users can like their favourite quotes, as a final step, we'll allow\nfor sorting quotes on the listing page by the number of likes they have."),(0,o.kt)("p",null,"Let's update ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/pages/index.astro"))," to read a ",(0,o.kt)("inlineCode",{parentName:"p"},"sort")," query string parameter\nand use it the GraphQL query that we make to our API:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'---\n// ...\n\n// highlight-start\nconst allowedSortFields = ["createdAt", "likes"];\nconst searchParamSort = new URL(Astro.request.url).searchParams.get("sort");\nconst sort = allowedSortFields.includes(searchParamSort) ? searchParamSort : "createdAt";\n// highlight-end\n\nconst { data } = await quotesApi.query(gql`\n  query {\n// highlight-next-line\n    quotes(orderBy: {field: ${sort}, direction: DESC}) {\n      id\n      quote\n      saidBy\n      likes\n      createdAt\n      movie {\n        id\n        name\n      }\n    }\n  }\n`);\n\nconst quotes = data?.quotes || [];\n---\n// highlight-next-line\n<Layout title="All quotes" page={`listing-${sort}`}>\n...\n')),(0,o.kt)("p",null,"Then let's replace the 'All quotes' link in the ",(0,o.kt)("inlineCode",{parentName:"p"},"<nav>")," in ",(0,o.kt)("strong",{parentName:"p"},(0,o.kt)("inlineCode",{parentName:"strong"},"src/layouts/Layout.astro")),"\nwith two new links:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-astro"},'<nav class="prose mx-auto mb-6 border-y border-gray-200 flex">\n// highlight-start\n  <a href="/?sort=createdAt" class={`p-3 ${page === "listing-createdAt" && navActiveClasses}`}>Latest quotes</a>\n  <a href="/?sort=likes" class={`p-3 ${page === "listing-likes" && navActiveClasses}`}>Top quotes</a>\n// highlight-end\n  <a href="/add" class={`p-3 ${page === "add" && navActiveClasses}`}>Add a quote</a>\n</nav>\n')),(0,o.kt)("p",null,"With these few extra lines of code, our users can now sort quotes by when they\nwere created or by the number of likes that they have. Neat!"),(0,o.kt)("h2",{id:"wrapping-up"},"Wrapping up"),(0,o.kt)("p",null,"And we're done \u2014 you now have the knowledge you need to build a full stack\napplication on top of Platformatic DB."),(0,o.kt)("p",null,"We can't wait to see what you'll build next!"))}d.isMDXComponent=!0}}]);